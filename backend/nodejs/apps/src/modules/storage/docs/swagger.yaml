openapi: 3.0.0
info:
  title: Storage API
  description: |
    Storage service API for document management, versioning, and retrieval.
    Supports multiple storage backends including S3, Azure Blob Storage, and local storage.
    Provides document upload, download, versioning, and buffer management capabilities.
  version: 1.0.0

servers:
  - url: /api/v1/document
    description: Base Storage API URL

tags:
  - name: Document Upload
    description: Document upload operations
  - name: Document Management
    description: Document CRUD and retrieval operations
  - name: Document Buffer
    description: Document buffer read/write operations
  - name: Version Control
    description: Document versioning and rollback operations
  - name: Internal
    description: Internal service-to-service endpoints

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: User authentication token

  parameters:
    DocumentId:
      name: documentId
      in: path
      required: true
      description: Unique identifier for the document (MongoDB ObjectId)
      schema:
        type: string
        pattern: '^[0-9a-fA-F]{24}$'
        example: '507f1f77bcf86cd799439011'
    Version:
      name: version
      in: query
      required: false
      description: Document version number (0-indexed, where 0 is the first version)
      schema:
        type: integer
        minimum: 0
        example: 0
    ExpirationTime:
      name: expirationTimeInSeconds
      in: query
      required: false
      description: Expiration time for signed URL in seconds
      schema:
        type: integer
        minimum: 1
        default: 3600
        example: 3600

  schemas:
    StorageVendor:
      type: string
      enum:
        - s3
        - azureBlob
        - local
      description: Supported storage vendors

    DocumentPermission:
      type: string
      enum:
        - owner
        - editor
        - commentator
        - readonly
      description: Document access permission levels

    StorageInfo:
      type: object
      properties:
        url:
          type: string
          description: URL to the stored document
          example: 'https://storage.example.com/documents/my-document.pdf'
        localPath:
          type: string
          description: Local file path (only for local storage)
          example: '/storage/documents/my-document.pdf'

    CustomMetadata:
      type: object
      properties:
        key:
          type: string
          description: Metadata key
          example: 'department'
        value:
          type: string
          description: Metadata value
          example: 'engineering'

    DocumentVersion:
      type: object
      properties:
        version:
          type: integer
          description: Version number
          example: 1
        userAssignedVersionLabel:
          type: string
          description: User-assigned version label
          example: 'v1.0.0'
        s3:
          $ref: '#/components/schemas/StorageInfo'
        azureBlob:
          $ref: '#/components/schemas/StorageInfo'
        local:
          $ref: '#/components/schemas/StorageInfo'
        note:
          type: string
          description: Version note/description
          example: 'Initial release'
        extension:
          type: string
          description: File extension
          example: '.pdf'
        currentVersion:
          type: integer
          description: Current version indicator
        createdAt:
          type: integer
          format: int64
          description: Version creation timestamp (epoch milliseconds)
          example: 1702732800000
        mutationCount:
          type: integer
          description: Number of mutations
          example: 5
        initiatedByUserId:
          type: string
          description: User ID who created this version
          example: '507f1f77bcf86cd799439011'
        size:
          type: integer
          description: File size in bytes
          example: 1048576

    Document:
      type: object
      required:
        - _id
        - documentName
        - isVersionedFile
        - orgId
        - storageVendor
      properties:
        _id:
          type: string
          description: Document unique identifier
          example: '507f1f77bcf86cd799439011'
        documentName:
          type: string
          description: Name of the document (without extension)
          example: 'quarterly-report'
        alternateDocumentName:
          type: string
          description: Alternate name for the document
          example: 'Q4 2024 Report'
        documentPath:
          type: string
          description: Storage path for the document
          example: 'org123/documents/reports'
        isVersionedFile:
          type: boolean
          description: Whether the document supports versioning
          example: true
        orgId:
          type: string
          description: Organization ID
          example: '507f1f77bcf86cd799439011'
        mutationCount:
          type: integer
          description: Number of mutations
          example: 3
        permissions:
          $ref: '#/components/schemas/DocumentPermission'
        initiatorUserId:
          type: string
          description: User ID who created the document
          example: '507f1f77bcf86cd799439011'
        sizeInBytes:
          type: integer
          description: File size in bytes
          example: 2097152
        mimeType:
          type: string
          description: MIME type of the document
          example: 'application/pdf'
        extension:
          type: string
          description: File extension including dot
          example: '.pdf'
        versionHistory:
          type: array
          items:
            $ref: '#/components/schemas/DocumentVersion'
          description: History of document versions
        customMetadata:
          type: array
          items:
            $ref: '#/components/schemas/CustomMetadata'
          description: Custom metadata key-value pairs
        currentVersion:
          type: integer
          description: Current version number
          example: 0
        tags:
          type: array
          items:
            type: string
          description: Document tags
          example: ['report', 'quarterly', 'finance']
        createdAt:
          type: integer
          format: int64
          description: Creation timestamp (epoch milliseconds)
          example: 1702732800000
        updatedAt:
          type: integer
          format: int64
          description: Last update timestamp (epoch milliseconds)
          example: 1702819200000
        isDeleted:
          type: boolean
          description: Whether the document is deleted
          example: false
        deletedByUserId:
          type: string
          description: User ID who deleted the document
        storageVendor:
          $ref: '#/components/schemas/StorageVendor'
        s3:
          $ref: '#/components/schemas/StorageInfo'
        azureBlob:
          $ref: '#/components/schemas/StorageInfo'
        local:
          $ref: '#/components/schemas/StorageInfo'

    UploadDocumentRequest:
      type: object
      required:
        - documentName
        - isVersionedFile
        - file
      properties:
        documentName:
          type: string
          description: Name of the document (without extension)
          example: 'annual-report'
        documentPath:
          type: string
          description: Custom storage path for the document
          example: 'documents/reports/2024'
        alternateDocumentName:
          type: string
          description: Alternate display name
          example: 'Annual Report 2024'
        permissions:
          type: string
          enum:
            - owner
            - editor
            - commentator
            - readonly
          description: Access permission level
          example: 'editor'
        isVersionedFile:
          type: string
          description: Whether to enable versioning (string 'true' or 'false')
          example: 'true'
        file:
          type: string
          format: binary
          description: The file to upload

    CreatePlaceholderRequest:
      type: object
      required:
        - documentName
        - documentPath
        - extension
      properties:
        documentName:
          type: string
          description: Name of the document (without extension, no forward slashes)
          example: 'project-spec'
        alternateDocumentName:
          type: string
          description: Alternate display name
          example: 'Project Specification Document'
        documentPath:
          type: string
          description: Storage path for the document
          example: 'org123/projects/specs'
        permissions:
          type: string
          enum:
            - owner
            - editor
            - commentator
            - readonly
          description: Access permission level
          example: 'editor'
        metaData:
          type: object
          description: Custom metadata
          example: { "project": "alpha", "priority": "high" }
        isVersionedFile:
          type: boolean
          description: Whether to enable versioning
          default: false
          example: true
        extension:
          type: string
          description: File extension without dot
          example: 'pdf'

    UploadNextVersionRequest:
      type: object
      required:
        - file
      properties:
        currentVersionNote:
          type: string
          description: Note for the current version (if modified before upload)
          example: 'Minor formatting changes before major update'
        nextVersionNote:
          type: string
          description: Note for the new version being uploaded
          example: 'Added new section on project milestones'
        file:
          type: string
          format: binary
          description: The new version file to upload

    RollbackRequest:
      type: object
      required:
        - note
      properties:
        note:
          type: string
          description: Note explaining the reason for rollback
          example: 'Rolling back to version 2 due to formatting issues in version 3'

    SignedUrlResponse:
      type: object
      properties:
        signedUrl:
          type: string
          description: Pre-signed URL for document download
          example: 'https://storage.example.com/documents/my-doc.pdf?token=xyz123&expires=1702819200'

    DirectUploadResponse:
      type: object
      properties:
        signedUrl:
          type: string
          description: Pre-signed URL for direct upload to storage
          example: 'https://storage.example.com/upload?token=xyz123&expires=1702819200'
        documentId:
          type: string
          description: Document ID for reference
          example: '507f1f77bcf86cd799439011'

    IsModifiedResponse:
      type: boolean
      description: Whether the document has been modified since last version
      example: true

    BufferResponse:
      type: object
      description: Document buffer data
      properties:
        type:
          type: string
          example: 'Buffer'
        data:
          type: array
          items:
            type: integer
          description: Buffer data as byte array

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: 'Document not found'
        code:
          type: string
          description: Error code
          example: 'NOT_FOUND'
        statusCode:
          type: integer
          description: HTTP status code
          example: 404

    SuccessResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
          example: 'Operation completed successfully'

security:
  - bearerAuth: []

paths:
  # ============================================
  # DOCUMENT UPLOAD ENDPOINTS
  # ============================================

  /upload:
    post:
      tags:
        - Document Upload
      summary: Upload a new document
      description: |
        Upload a new document to the storage service. Supports versioned and non-versioned files.
        Maximum file size is 1000MB. The document name cannot contain file extensions or forward slashes.
      operationId: uploadDocument
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UploadDocumentRequest'
            example:
              documentName: 'quarterly-financial-report'
              alternateDocumentName: 'Q4 2024 Financial Report'
              documentPath: 'finance/reports/2024'
              permissions: 'editor'
              isVersionedFile: 'true'
      responses:
        '200':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid request - bad document name, invalid storage type, or missing file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - invalid or missing authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/upload:
    post:
      tags:
        - Internal
      summary: Upload a new document (internal)
      description: |
        Internal endpoint for service-to-service document upload.
        Maximum file size is 100MB.
      operationId: uploadDocumentInternal
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UploadDocumentRequest'
      responses:
        '200':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # PLACEHOLDER ENDPOINTS
  # ============================================

  /placeholder:
    post:
      tags:
        - Document Upload
      summary: Create a document placeholder
      description: |
        Create a placeholder document entry without uploading the actual file.
        The file can be uploaded later using the direct upload endpoint.
        Document name cannot contain extensions or forward slashes.
      operationId: createPlaceholder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlaceholderRequest'
            example:
              documentName: 'project-proposal'
              alternateDocumentName: 'New Project Proposal 2024'
              documentPath: 'projects/proposals'
              permissions: 'editor'
              isVersionedFile: true
              extension: 'docx'
              metaData:
                project: 'Alpha'
                priority: 'high'
      responses:
        '200':
          description: Placeholder created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid request - document name contains extension or forward slash
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/placeholder:
    post:
      tags:
        - Internal
      summary: Create a document placeholder (internal)
      description: Internal endpoint for service-to-service placeholder creation.
      operationId: createPlaceholderInternal
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlaceholderRequest'
      responses:
        '200':
          description: Placeholder created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DOCUMENT MANAGEMENT ENDPOINTS
  # ============================================

  /{documentId}:
    get:
      tags:
        - Document Management
      summary: Get document by ID
      description: Retrieve document metadata by its unique identifier.
      operationId: getDocumentById
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Document details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid document ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Document Management
      summary: Delete document by ID
      description: Soft delete a document by marking it as deleted. The document is not physically removed.
      operationId: deleteDocumentById
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid document ID
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}:
    get:
      tags:
        - Internal
      summary: Get document by ID (internal)
      description: Internal endpoint for service-to-service document retrieval.
      operationId: getDocumentByIdInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Document details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
          
    delete:
      tags:
        - Internal
      summary: Delete document by ID (internal)
      description: Internal endpoint for service-to-service document deletion.
      operationId: deleteDocumentByIdInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DOCUMENT DOWNLOAD ENDPOINTS
  # ============================================

  /{documentId}/download:
    get:
      tags:
        - Document Management
      summary: Download document
      description: |
        Get a signed URL to download the document. For local storage, the file is served directly.
        Optionally specify a version number to download a specific version.
      operationId: downloadDocument
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
        - $ref: '#/components/parameters/Version'
        - $ref: '#/components/parameters/ExpirationTime'
      responses:
        '200':
          description: Signed URL for download or direct file stream
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignedUrlResponse'
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: File binary data (for local storage)
        '400':
          description: Invalid version or storage vendor mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}/download:
    get:
      tags:
        - Internal
      summary: Download document (internal)
      description: Internal endpoint for service-to-service document download.
      operationId: downloadDocumentInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
        - $ref: '#/components/parameters/Version'
        - $ref: '#/components/parameters/ExpirationTime'
      responses:
        '200':
          description: Signed URL for download
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignedUrlResponse'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DOCUMENT BUFFER ENDPOINTS
  # ============================================

  /{documentId}/buffer:
    get:
      tags:
        - Document Buffer
      summary: Get document buffer
      description: Retrieve the document content as a buffer. Optionally specify a version.
      operationId: getDocumentBuffer
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
        - $ref: '#/components/parameters/Version'
      responses:
        '200':
          description: Document buffer data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BufferResponse'
        '400':
          description: Invalid version number
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Document Buffer
      summary: Update document buffer
      description: Update the document content buffer by uploading a new file.
      operationId: updateDocumentBuffer
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: The file to upload as buffer
      responses:
        '200':
          description: Buffer updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}/buffer:
    get:
      tags:
        - Internal
      summary: Get document buffer (internal)
      description: Internal endpoint for service-to-service buffer retrieval.
      operationId: getDocumentBufferInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
        - $ref: '#/components/parameters/Version'
      responses:
        '200':
          description: Document buffer data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BufferResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Internal
      summary: Update document buffer (internal)
      description: Internal endpoint for service-to-service buffer update.
      operationId: updateDocumentBufferInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Buffer updated successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # VERSION CONTROL ENDPOINTS
  # ============================================

  /{documentId}/uploadNextVersion:
    post:
      tags:
        - Version Control
      summary: Upload next version
      description: |
        Upload a new version of a versioned document. 
        If the current document has been modified since the last version, 
        the current state is saved as a version before the new upload.
        The uploaded file must have the same extension as the original document.
      operationId: uploadNextVersion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UploadNextVersionRequest'
            example:
              currentVersionNote: 'Auto-saved changes before major update'
              nextVersionNote: 'Version 2.0 - Complete redesign of chapter 3'
      responses:
        '200':
          description: New version uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Document cannot be versioned or file format mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: File format mismatch with original document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}/uploadNextVersion:
    post:
      tags:
        - Internal
      summary: Upload next version (internal)
      description: Internal endpoint for service-to-service version upload.
      operationId: uploadNextVersionInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UploadNextVersionRequest'
      responses:
        '200':
          description: New version uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: File format mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'


  # ============================================
  # DIRECT UPLOAD ENDPOINTS
  # ============================================

  /{documentId}/directUpload:
    post:
      tags:
        - Document Upload
      summary: Get direct upload URL
      description: |
        Get a pre-signed URL for direct upload to the storage backend.
        This allows clients to upload files directly to S3/Azure without proxying through the API.
        First create a placeholder document, then use this endpoint to get the upload URL.
      operationId: getDirectUploadUrl
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Pre-signed URL for direct upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectUploadResponse'
              example:
                signedUrl: 'https://s3.amazonaws.com/bucket/doc.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=...'
                documentId: '507f1f77bcf86cd799439011'
        '400':
          description: Invalid storage type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '404':
          description: Document or document path not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}/directUpload:
    post:
      tags:
        - Internal
      summary: Get direct upload URL (internal)
      description: Internal endpoint for service-to-service direct upload URL generation.
      operationId: getDirectUploadUrlInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Pre-signed URL for direct upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectUploadResponse'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DOCUMENT DIFF ENDPOINTS
  # ============================================

  /{documentId}/isModified:
    get:
      tags:
        - Version Control
      summary: Check if document is modified
      description: |
        Check if the current document content differs from the last saved version.
        Compares the current buffer with the most recent version in history.
      operationId: checkDocumentModified
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Modification status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IsModifiedResponse'
              example: true
        '401':
          description: Unauthorized
        '404':
          description: Document not found or organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /internal/{documentId}/isModified:
    get:
      tags:
        - Internal
      summary: Check if document is modified (internal)
      description: Internal endpoint for service-to-service modification check.
      operationId: checkDocumentModifiedInternal
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DocumentId'
      responses:
        '200':
          description: Modification status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IsModifiedResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # CONFIGURATION ENDPOINTS
  # ============================================

  /updateAppConfig:
    post:
      tags:
        - Internal
      summary: Update storage configuration
      description: |
        Internal endpoint to refresh storage configuration from the configuration manager.
        Used when storage settings are updated and need to be reloaded.
      operationId: updateAppConfig
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Storage configuration updated successfully'
                  config:
                    type: object
                    description: Updated configuration object
        '401':
          description: Unauthorized - requires FETCH_CONFIG scope
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'



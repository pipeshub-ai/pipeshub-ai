openapi: 3.0.0
info:
  title: Authentication Service API
  description: |
    RESTful API for the Authentication Service - providing user authentication, authorization, 
    session management, and multi-factor authentication capabilities with support for multiple 
    authentication methods (Password, OTP, Google OAuth, Microsoft OAuth, Azure AD, SAML SSO, and Generic OAuth).
  version: 1.0.0
  contact:
    name: API Support
    email: support@yourcompany.com

servers:
  - url: /api/v1
    description: Base API URL

tags:
  - name: User Account
    description: User account authentication and management operations
  - name: Organization Auth Config
    description: Organization authentication configuration management
  - name: SAML
    description: SAML Single Sign-On operations
  - name: OAuth
    description: OAuth token exchange operations

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Bearer token for authenticated requests
    scopedToken:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Scoped JWT token for service-to-service authentication

  schemas:
    AuthMethod:
      type: object
      properties:
        type:
          type: string
          enum: [samlSso, otp, password, google, microsoft, azureAd, oauth]
          description: Type of authentication method
      required:
        - type

    AuthStep:
      type: object
      properties:
        order:
          type: integer
          description: Order of the authentication step (must be unique)
          minimum: 1
        allowedMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethod'
          description: List of allowed authentication methods for this step
          minItems: 1
      required:
        - order
        - allowedMethods

    AuthConfig:
      type: object
      properties:
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthStep'
          description: List of authentication steps
          minItems: 1
          maxItems: 3
      required:
        - authMethods

    InitAuthRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User email address
      required:
        - email

    InitAuthResponse:
      type: object
      properties:
        currentStep:
          type: integer
          description: Current authentication step (0-indexed)
        allowedMethods:
          type: array
          items:
            type: string
            enum: [samlSso, otp, password, google, microsoft, azureAd, oauth]
          description: List of allowed authentication methods for the current step
        message:
          type: string
          description: Response message
        authProviders:
          type: object
          description: Authentication provider configurations
          properties:
            google:
              type: object
              properties:
                clientId:
                  type: string
                  description: Google OAuth client ID
            microsoft:
              type: object
              properties:
                tenantId:
                  type: string
                  description: Microsoft tenant ID
            azuread:
              type: object
              properties:
                tenantId:
                  type: string
                  description: Azure AD tenant ID
            oauth:
              type: object
              properties:
                clientId:
                  type: string
                  description: OAuth client ID
                authorizationEndpoint:
                  type: string
                  description: OAuth authorization endpoint
                providerName:
                  type: string
                  description: OAuth provider name
                redirectUri:
                  type: string
                  description: OAuth redirect URI

    AuthenticateRequest:
      type: object
      properties:
        method:
          type: string
          enum: [samlSso, otp, password, google, microsoft, azureAd, oauth]
          description: Authentication method to use
        credentials:
          type: object
          description: Credentials based on the authentication method
          properties:
            password:
              type: string
              description: Password (for password method)
            otp:
              type: integer
              description: OTP code (for OTP method)
            credential:
              type: string
              description: Google ID token (for google method)
            accessToken:
              type: string
              description: Access token (for microsoft/azureAd/oauth methods)
            idToken:
              type: string
              description: ID token (for oauth method)
      required:
        - method
        - credentials

    AuthenticateResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, fully_authenticated]
          description: Authentication status
        nextStep:
          type: integer
          description: Next authentication step (if multi-step)
        allowedMethods:
          type: array
          items:
            type: string
          description: Allowed methods for next step
        authProviders:
          type: object
          description: Authentication provider configurations for next step
        message:
          type: string
          description: Response message (for fully authenticated)
        accessToken:
          type: string
          description: JWT access token (for fully authenticated)
        refreshToken:
          type: string
          description: JWT refresh token (for fully authenticated)

    GenerateOtpRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User email address
      required:
        - email

    ResetPasswordRequest:
      type: object
      properties:
        newPassword:
          type: string
          description: New password
          minLength: 8
        currentPassword:
          type: string
          description: Current password (required for authenticated password reset)
      required:
        - newPassword
        - currentPassword

    ResetPasswordViaTokenRequest:
      type: object
      properties:
        password:
          type: string
          description: New password
          minLength: 8
      required:
        - password

    ForgotPasswordRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User email address
      required:
        - email

    RefreshTokenResponse:
      type: object
      properties:
        user:
          type: object
          description: User information
        accessToken:
          type: string
          description: New JWT access token
      required:
        - accessToken

    OAuthExchangeRequest:
      type: object
      properties:
        code:
          type: string
          description: Authorization code from OAuth provider
        email:
          type: string
          format: email
          description: User email address
        provider:
          type: string
          description: OAuth provider name
        redirectUri:
          type: string
          description: Redirect URI used in OAuth flow
      required:
        - code
        - email
        - provider
        - redirectUri

    OAuthExchangeResponse:
      type: object
      properties:
        access_token:
          type: string
          description: OAuth access token
        id_token:
          type: string
          description: OAuth ID token
        token_type:
          type: string
          description: Token type (usually "Bearer")
        expires_in:
          type: integer
          description: Token expiration time in seconds

    SetupAuthConfigRequest:
      type: object
      properties:
        contactEmail:
          type: string
          format: email
          description: Organization contact email
        registeredName:
          type: string
          description: Organization registered name
        adminFullName:
          type: string
          description: Admin full name
        sendEmail:
          type: boolean
          description: Whether to send setup email
          default: false
      required:
        - contactEmail
        - registeredName
        - adminFullName

    AuthMethodResponse:
      type: object
      properties:
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthStep'
          description: List of authentication steps configured for the organization

    UpdateAuthMethodResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
        authMethod:
          type: array
          items:
            $ref: '#/components/schemas/AuthStep'
          description: Updated authentication steps

    PasswordCheckResponse:
      type: object
      properties:
        isPasswordAuthEnabled:
          type: boolean
          description: Whether password authentication is enabled for the organization

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        code:
          type: integer
          description: Error code
        details:
          type: object
          description: Additional error details

    SuccessResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
        data:
          type: string
          description: Additional response data

security:
  - bearerAuth: []

paths:
  # User Account Routes
  /userAccount/initAuth:
    post:
      tags:
        - User Account
      summary: Initialize authentication session
      description: |
        Initialize an authentication session for a user. This creates a session and returns 
        the available authentication methods for the first step.
      operationId: initAuth
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitAuthRequest'
        required: true
      responses:
        '200':
          description: Authentication session initialized successfully
          headers:
            x-session-token:
              schema:
                type: string
              description: Session token for subsequent authentication requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitAuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User or organization configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/authenticate:
    post:
      tags:
        - User Account
      summary: Authenticate user
      description: |
        Authenticate a user using the specified method. This endpoint supports multi-step 
        authentication. If authentication is successful but more steps are required, it returns 
        the next step information. If all steps are completed, it returns access and refresh tokens.
      operationId: authenticate
      parameters:
        - name: x-session-token
          in: header
          required: true
          description: Session token received from the initAuth endpoint (required for session validation)
          schema:
            type: string
          example: 'session-token-here'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticateRequest'
        required: true
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticateResponse'
        '400':
          description: Invalid request or authentication method
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Session or user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: OTP expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/login/otp/generate:
    post:
      tags:
        - User Account
      summary: Generate OTP for login
      description: Generate and send a one-time password (OTP) to the user's email for login
      operationId: generateLoginOtp
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateOtpRequest'
        required: true
      responses:
        '200':
          description: OTP generated and sent successfully
          content:
            application/json:
              schema:
                type: string
                example: 'OTP sent'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Account is blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/password/reset:
    post:
      tags:
        - User Account
      summary: Reset password (authenticated)
      description: Reset password for an authenticated user. Requires current password verification.
      operationId: resetPassword
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
        required: true
      responses:
        '200':
          description: Password reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid request or password validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Current password is incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User credentials not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/password/reset/token:
    post:
      tags:
        - User Account
      summary: Reset password via email token
      description: Reset password using a token received via email link. Requires a scoped JWT token.
      operationId: resetPasswordViaToken
      security:
        - scopedToken: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordViaTokenRequest'
        required: true
      responses:
        '200':
          description: Password reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid request or password validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/password/forgot:
    post:
      tags:
        - User Account
      summary: Request password reset email
      description: Send a password reset link to the user's email address
      operationId: forgotPassword
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
        required: true
      responses:
        '200':
          description: Password reset email sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/refresh/token:
    post:
      tags:
        - User Account
      summary: Refresh access token
      description: Get a new access token using a valid refresh token. Requires a scoped JWT token.
      operationId: refreshToken
      security:
        - scopedToken: []
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '400':
          description: Invalid request or account is blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/logout/manual:
    post:
      tags:
        - User Account
      summary: Manual logout
      description: Log out the current user session
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logged out successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/internal/password/check:
    get:
      tags:
        - User Account
      summary: Check if password authentication is enabled
      description: Check if password authentication method is enabled for the organization. Internal endpoint requiring scoped token.
      operationId: checkPasswordMethod
      security:
        - scopedToken: []
      responses:
        '200':
          description: Password method check successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PasswordCheckResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /userAccount/oauth/exchange:
    post:
      tags:
        - OAuth
      summary: Exchange OAuth authorization code for tokens
      description: Exchange an OAuth authorization code for access and ID tokens
      operationId: exchangeOAuthToken
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthExchangeRequest'
        required: true
      responses:
        '200':
          description: Token exchange successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthExchangeResponse'
        '400':
          description: Invalid request or OAuth configuration missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Organization Auth Config Routes
  /orgAuthConfig/authMethods:
    get:
      tags:
        - Organization Auth Config
      summary: Get organization authentication methods
      description: Retrieve the configured authentication methods for the organization. Admin only.
      operationId: getAuthMethods
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Authentication methods retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMethodResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Organization configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /orgAuthConfig:
    post:
      tags:
        - Organization Auth Config
      summary: Set up organization authentication configuration
      description: |
        Create initial authentication configuration for an organization. This endpoint creates 
        both the organization and its authentication configuration. Admin only.
      operationId: setupAuthConfig
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetupAuthConfigRequest'
        required: true
      responses:
        '200':
          description: Configuration already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Org config already done'
        '201':
          description: Authentication configuration created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Org Auth Config created successfully'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /orgAuthConfig/updateAuthMethod:
    post:
      tags:
        - Organization Auth Config
      summary: Update organization authentication methods
      description: |
        Update the authentication methods configuration for an organization. Validates that:
        - At least one authentication step is required
        - Maximum of 3 authentication steps allowed
        - Each step has a unique order
        - No duplicate authentication methods within a step
        - No duplicate authentication methods across steps
        Admin only.
      operationId: updateAuthMethod
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthConfig'
        required: true
      responses:
        '200':
          description: Authentication methods updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateAuthMethodResponse'
        '400':
          description: Invalid request or validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Organization configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # SAML Routes
  /saml/signIn:
    get:
      tags:
        - SAML
      summary: Initiate SAML sign-in
      description: |
        Initiate SAML Single Sign-On authentication. This endpoint redirects to the SAML 
        identity provider for authentication.
      operationId: signInViaSAML
      parameters:
        - name: email
          in: query
          description: User email address
          required: true
          schema:
            type: string
            format: email
        - name: sessionToken
          in: query
          description: Session token from authentication initialization
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to SAML identity provider
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User or organization configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /saml/signIn/callback:
    post:
      tags:
        - SAML
      summary: SAML authentication callback
      description: |
        Handle the callback from SAML identity provider after authentication. This endpoint 
        processes the SAML response, validates the user, and completes the authentication flow.
      operationId: samlCallback
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                SAMLResponse:
                  type: string
                  description: SAML response from identity provider
                RelayState:
                  type: string
                  description: Base64 encoded relay state containing orgId and sessionToken
      responses:
        '200':
          description: Authentication successful - redirects to frontend
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Sets accessToken and refreshToken cookies
        '302':
          description: Redirect to frontend success page
        '400':
          description: Invalid request or authentication method not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Invalid session or SAML response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /saml/updateAppConfig:
    post:
      tags:
        - SAML
      summary: Update application configuration
      description: |
        Reload and update the application configuration. This endpoint is used to refresh 
        configuration without restarting the service. Requires scoped token with FETCH_CONFIG scope.
      operationId: updateAppConfig
      security:
        - scopedToken: []
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Auth configuration updated successfully'
                  config:
                    type: object
                    description: Updated configuration object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'


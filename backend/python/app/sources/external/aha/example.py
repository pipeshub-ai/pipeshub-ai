"""
Full example demonstrating usage of Aha client with:
 - Bearer token authentication
 - API key (query param) authentication
 - pagination helper usage
 - multiple endpoint calls

Set environment vars or replace the placeholders below before running the demo.
"""

import asyncio
import logging
import os

from app.sources.client.aha.aha import (
    AhaApiKeyConfig,
    AhaClient,
    AhaTokenConfig,
)
from app.sources.external.aha.aha_data_source import (
    AhaDataSource,  # generated by generator script
)

TOP_FEATURES_LIMIT = 10


async def demo_with_bearer_token(logger: logging.Logger, token: str, base_url: str) -> None:
    logger.info("Demo: Bearer token authentication")
    cfg = AhaTokenConfig(base_url=base_url, access_token=token)
    client = AhaClient.build_with_token(cfg)
    aha = client.get_client()

    # Fetch products
    products_resp = await aha.get_products()
    logger.info("Products (raw): %s", products_resp.data)

    # If there are products, fetch features for the first product (best-effort)
    products = (products_resp.data or {}).get("products", [])
    if products:
        first = products[0]
        pid = first.get("id") or first.get("reference_num") or first.get("slug") or first.get("identifier")
        if pid:
            features_resp = await aha.get_features(params={"product_id": pid})
            logger.info("Features for product %s: %s", pid, features_resp.data)
    # Use pagination helper to iterate features pages
    async for page in aha.iter_pages("/features", params=None, per_page=25):
        logger.info("Got features page with keys: %s", list(page.keys()))
        break  # demo: just show first page


async def demo_with_api_key(logger: logging.Logger, api_key: str, base_url: str) -> None:
    logger.info("Demo: API key (query param) authentication")
    cfg = AhaApiKeyConfig(base_url=base_url, api_key=api_key)
    client = AhaClient.build_with_api_key(cfg)
    aha = client.get_client()

    # Fetch ideas
    ideas_resp = await aha.get_ideas(params={"per_page": TOP_FEATURES_LIMIT})
    logger.info("Ideas (raw): %s", ideas_resp.data)

    # Example using generated AhaDataSource
    ds = AhaDataSource(client)
    products = await ds.list_products()
    logger.info("AhaDataSource.list_products returned keys: %s", list((products.data or {}).keys()))


async def main() -> None:
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger("AhaExample")

    base_url = os.getenv("AHA_BASE_URL", "https://example.aha.io/api/v1")
    bearer = os.getenv("AHA_TOKEN", "")
    api_key = os.getenv("AHA_API_KEY", "")

    if bearer:
        await demo_with_bearer_token(logger, bearer, base_url)
    elif api_key:
        await demo_with_api_key(logger, api_key, base_url)
    else:
        logger.error("No credentials found. Set AHA_ACCESS_TOKEN or AHA_API_KEY environment variable.")


if __name__ == "__main__":
    asyncio.run(main())

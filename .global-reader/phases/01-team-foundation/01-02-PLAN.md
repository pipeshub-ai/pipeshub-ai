---
phase: 01-team-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts
  - backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts
autonomous: true

must_haves:
  truths:
    - "Global Reader team is created when a new organization is created"
    - "Team creation is non-blocking (org creation succeeds even if team fails)"
    - "Team creation uses admin context from org creation request"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts"
      provides: "GlobalReaderTeamService DI binding"
      contains: "GlobalReaderTeamService"
    - path: "backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts"
      provides: "Team creation call in createOrg method"
      contains: "ensureGlobalReaderTeamExists"
  key_links:
    - from: "org.controller.ts"
      to: "GlobalReaderTeamService"
      via: "Inversify DI injection"
      pattern: "@inject\\('GlobalReaderTeamService'\\)"
    - from: "org.controller.ts"
      to: "ensureGlobalReaderTeamExists"
      via: "method call after org save"
      pattern: "globalReaderTeamService\\.ensureGlobalReaderTeamExists"
    - from: "userManager.container.ts"
      to: "GlobalReaderTeamService"
      via: "container binding"
      pattern: "bind.*GlobalReaderTeamService"
---

<objective>
Integrate GlobalReaderTeamService into the application to automatically create the Global Reader team when an organization is created.

Purpose: Wire the service into the DI container and call it during org creation, following the same pattern as the "everyone" UserGroup creation.

Output:
1. GlobalReaderTeamService bound in userManager.container.ts
2. Service injected into OrgController
3. ensureGlobalReaderTeamExists called after org is saved in createOrg method
</objective>

<execution_context>
@/Users/Edward/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Edward/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts
@backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts
@.global-reader/phases/01-team-foundation/01-01-SUMMARY.md
@.global-reader/phases/01-team-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register GlobalReaderTeamService in DI container</name>
  <files>backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts</files>
  <action>
Add GlobalReaderTeamService to the Inversify container following the existing patterns.

1. Add import at top of file (after other service imports, around line 13):
```typescript
import { GlobalReaderTeamService } from '../services/globalReaderTeam.service';
```

2. Add service binding in initializeServices method (after authService binding, around line 56-57):
```typescript
const globalReaderTeamService = new GlobalReaderTeamService(
  appConfig,
  container.get('Logger'),
);
container
  .bind<GlobalReaderTeamService>('GlobalReaderTeamService')
  .toDynamicValue(() => globalReaderTeamService);
```

3. Update OrgController binding to include GlobalReaderTeamService (around line 81-88):
```typescript
container.bind<OrgController>('OrgController').toDynamicValue(() => {
  return new OrgController(
    appConfig,
    container.get<MailService>('MailService'),
    container.get('Logger'),
    container.get<EntitiesEventProducer>('EntitiesEventProducer'),
    container.get<GlobalReaderTeamService>('GlobalReaderTeamService'),
  );
});
```

Follow exact binding pattern used for AuthService (toDynamicValue with arrow function).
  </action>
  <verify>
1. Import added: `grep -q "import { GlobalReaderTeamService }" backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts`
2. Binding added: `grep -q "bind.*GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts`
3. OrgController updated: `grep "GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts | wc -l` should be 3+
  </verify>
  <done>
- GlobalReaderTeamService imported in container file
- Service instantiated with appConfig and Logger
- Service bound with 'GlobalReaderTeamService' identifier
- OrgController binding updated to include GlobalReaderTeamService
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject and call GlobalReaderTeamService in OrgController</name>
  <files>backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts</files>
  <action>
Update OrgController to use GlobalReaderTeamService during org creation.

1. Add import at top of file (after other service imports):
```typescript
import { GlobalReaderTeamService } from '../services/globalReaderTeam.service';
```

2. Add service to constructor (add as last parameter, around line 44-50):
```typescript
constructor(
  @inject('AppConfig') private config: AppConfig,
  @inject('MailService') private mailService: MailService,
  @inject('Logger') private logger: Logger,
  @inject('EntitiesEventProducer') private eventService: EntitiesEventProducer,
  @inject('GlobalReaderTeamService') private globalReaderTeamService: GlobalReaderTeamService,
) {}
```

3. Call ensureGlobalReaderTeamExists after org is saved, before sending email (around line 298, after eventService.stop() and before sendEmail block):
```typescript
// Create Global Reader team for the new organization
// This is non-blocking - errors are logged but don't fail org creation
await this.globalReaderTeamService.ensureGlobalReaderTeamExists(
  org._id.toString(),
  adminUser._id.toString(),
  {
    'Content-Type': 'application/json',
    // Note: No auth headers needed as this is system-level creation during org setup
  },
);
```

Place this call after line 324 (after `await this.eventService.stop();`) and before line 326 (before `if (sendEmail) {`).

The timing is important:
- After org is committed (so orgId is valid)
- After events are published (org exists in system)
- Before email is sent (so Global Reader exists when user logs in)
- Uses fire-and-forget pattern (await but don't let failures propagate)
  </action>
  <verify>
1. Import added: `grep -q "import { GlobalReaderTeamService }" backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts`
2. Constructor updated: `grep -q "@inject('GlobalReaderTeamService')" backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts`
3. Method called: `grep -q "ensureGlobalReaderTeamExists" backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts`
4. TypeScript compiles: `cd backend/nodejs/apps && npx tsc --noEmit`
  </verify>
  <done>
- GlobalReaderTeamService imported in OrgController
- Service injected via constructor with @inject decorator
- ensureGlobalReaderTeamExists called in createOrg method
- Call placed after org save but before sendEmail
- Call is non-blocking (errors logged, not thrown)
  </done>
</task>

</tasks>

<verification>
1. Full TypeScript compilation check:
   ```bash
   cd backend/nodejs/apps && npm run build
   ```
   Or at minimum:
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit
   ```

2. Verify wiring is complete:
   ```bash
   # Import in container
   grep "GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts

   # Import and injection in controller
   grep "GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts

   # Method call in createOrg
   grep "ensureGlobalReaderTeamExists" backend/nodejs/apps/src/modules/user_management/controller/org.controller.ts
   ```

3. Verify no breaking changes:
   ```bash
   cd backend/nodejs/apps && npm run lint
   ```
</verification>

<success_criteria>
- [ ] GlobalReaderTeamService bound in userManager.container.ts
- [ ] OrgController constructor includes GlobalReaderTeamService parameter
- [ ] createOrg method calls ensureGlobalReaderTeamExists after org save
- [ ] TypeScript compiles without errors
- [ ] Lint passes without errors
- [ ] Integration is non-blocking (service catches its own errors)
</success_criteria>

<output>
After completion, create `.global-reader/phases/01-team-foundation/01-02-SUMMARY.md`
</output>

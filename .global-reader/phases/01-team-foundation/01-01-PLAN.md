---
phase: 01-team-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
autonomous: true

must_haves:
  truths:
    - "GlobalReaderTeamService class exists and is injectable"
    - "Service can check if Global Reader team exists via Python API"
    - "Service can create Global Reader team via Python API"
    - "Service is idempotent (safe to call multiple times)"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts"
      provides: "GlobalReaderTeamService with ensureGlobalReaderTeamExists method"
      exports: ["GlobalReaderTeamService"]
      min_lines: 60
  key_links:
    - from: "globalReaderTeam.service.ts"
      to: "AIServiceCommand"
      via: "HTTP client import"
      pattern: "import.*AIServiceCommand"
    - from: "globalReaderTeam.service.ts"
      to: "AppConfig"
      via: "Inversify DI"
      pattern: "@inject\\('AppConfig'\\)"
---

<objective>
Create the GlobalReaderTeamService that ensures the Global Reader team exists for an organization.

Purpose: Provide a reusable service that can be called during org creation to automatically provision the Global Reader team, following the established pattern of system-managed entities like "everyone" UserGroup.

Output: A new service file with `ensureGlobalReaderTeamExists(orgId, headers)` method that:
1. Checks if Global Reader team already exists (idempotent)
2. Creates the team if not present
3. Logs success/failure without throwing (non-blocking)
</objective>

<execution_context>
@/Users/Edward/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Edward/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/nodejs/apps/src/modules/user_management/services/auth.service.ts
@backend/nodejs/apps/src/modules/user_management/controller/teams.controller.ts
@backend/nodejs/apps/src/libs/commands/ai_service/ai.service.command.ts
@.global-reader/phases/01-team-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlobalReaderTeamService</name>
  <files>backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts</files>
  <action>
Create a new service file following the established patterns from auth.service.ts and teams.controller.ts.

Structure:
```typescript
import { inject, injectable } from 'inversify';
import { Logger } from '../../../libs/services/logger.service';
import { AppConfig } from '../../tokens_manager/config/config';
import { AICommandOptions, AIServiceCommand } from '../../../libs/commands/ai_service/ai.service.command';
import { HttpMethod } from '../../../libs/enums/http-methods.enum';
import { HTTP_STATUS } from '../../../libs/enums/http-status.enum';

// Constants for the Global Reader team
export const GLOBAL_READER_TEAM_NAME = 'Global Reader';
export const GLOBAL_READER_TEAM_DESCRIPTION = 'System-managed team for global read access across the organization';

@injectable()
export class GlobalReaderTeamService {
  constructor(
    @inject('AppConfig') private config: AppConfig,
    @inject('Logger') private logger: Logger,
  ) {}

  /**
   * Ensures the Global Reader team exists for the given organization.
   * This method is idempotent - safe to call multiple times.
   *
   * @param orgId - The organization ID
   * @param userId - The user ID (creator/admin)
   * @param headers - HTTP headers to pass through (for auth context)
   * @returns Promise<void> - Does not throw on failure, only logs
   */
  async ensureGlobalReaderTeamExists(
    orgId: string,
    userId: string,
    headers: Record<string, string>,
  ): Promise<void> {
    try {
      // Step 1: Check if team already exists
      const exists = await this.checkTeamExists(orgId, headers);
      if (exists) {
        this.logger.info('Global Reader team already exists', { orgId });
        return;
      }

      // Step 2: Create the team
      await this.createTeam(orgId, userId, headers);
      this.logger.info('Global Reader team created successfully', { orgId });
    } catch (error) {
      // Log but don't throw - team creation failure should not block org creation
      this.logger.error('Failed to ensure Global Reader team exists', {
        orgId,
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }
  }

  private async checkTeamExists(
    orgId: string,
    headers: Record<string, string>,
  ): Promise<boolean> {
    const searchParams = new URLSearchParams({
      search: GLOBAL_READER_TEAM_NAME,
      limit: '100',
    });

    const aiCommandOptions: AICommandOptions = {
      uri: `${this.config.connectorBackend}/api/v1/entity/team/list?${searchParams.toString()}`,
      method: HttpMethod.GET,
      headers: {
        ...headers,
        'Content-Type': 'application/json',
      },
    };

    const aiCommand = new AIServiceCommand(aiCommandOptions);
    const response = await aiCommand.execute();

    if (response.statusCode !== HTTP_STATUS.OK) {
      this.logger.warn('Failed to check for existing Global Reader team', {
        statusCode: response.statusCode,
        orgId,
      });
      return false;
    }

    // Check if exact match exists for this org
    const teams = response.data?.teams || [];
    return teams.some(
      (team: { name: string; orgId: string }) =>
        team.name === GLOBAL_READER_TEAM_NAME && team.orgId === orgId,
    );
  }

  private async createTeam(
    orgId: string,
    userId: string,
    headers: Record<string, string>,
  ): Promise<void> {
    const teamPayload = {
      name: GLOBAL_READER_TEAM_NAME,
      description: GLOBAL_READER_TEAM_DESCRIPTION,
      orgId,
      createdBy: userId,
    };

    const aiCommandOptions: AICommandOptions = {
      uri: `${this.config.connectorBackend}/api/v1/entity/team`,
      method: HttpMethod.POST,
      headers: {
        ...headers,
        'Content-Type': 'application/json',
      },
      body: teamPayload,
    };

    const aiCommand = new AIServiceCommand(aiCommandOptions);
    const response = await aiCommand.execute();

    if (response.statusCode !== HTTP_STATUS.OK) {
      throw new Error(
        `Failed to create Global Reader team: ${response.msg || 'Unknown error'}`,
      );
    }
  }
}
```

Key implementation details:
- Follow exact DI pattern from auth.service.ts (@injectable, @inject decorators)
- Use AIServiceCommand like teams.controller.ts for HTTP calls
- Export constants for team name/description (reusable, testable)
- Non-throwing design: log errors but don't fail parent operations
- Idempotency: always check existence before creation

Backend architecture note:
- Teams are managed by the Python backend at `config.connectorBackend` (port 8088)
- Node.js backend calls Python via HTTP using AIServiceCommand
- This is the established pattern (see teams.controller.ts for reference)
  </action>
  <verify>
1. File exists: `ls backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts`
2. TypeScript compiles: `cd backend/nodejs/apps && npx tsc --noEmit src/modules/user_management/services/globalReaderTeam.service.ts`
3. Exports correct class: `grep -q "export class GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts`
  </verify>
  <done>
- GlobalReaderTeamService class exists with @injectable decorator
- ensureGlobalReaderTeamExists method accepts orgId, userId, headers
- Method checks for existing team before creating
- Method catches errors and logs without throwing
- Constants GLOBAL_READER_TEAM_NAME and GLOBAL_READER_TEAM_DESCRIPTION exported
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript compilation on the new file:
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit src/modules/user_management/services/globalReaderTeam.service.ts
   ```

2. Verify imports resolve:
   ```bash
   grep -c "import" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
   # Should show 5-6 import statements
   ```

3. Verify class structure:
   ```bash
   grep -E "@injectable|@inject|export class|async.*ensure" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
   ```

4. Verify description constant is used in createTeam method:
   ```bash
   grep -A5 "const teamPayload" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts | grep "GLOBAL_READER_TEAM_DESCRIPTION"
   # Should show: description: GLOBAL_READER_TEAM_DESCRIPTION,
   ```
</verification>

<success_criteria>
- [ ] globalReaderTeam.service.ts exists in services directory
- [ ] File compiles without TypeScript errors
- [ ] GlobalReaderTeamService class is exported
- [ ] ensureGlobalReaderTeamExists method is public
- [ ] checkTeamExists and createTeam are private helper methods
- [ ] Constants are exported for team name and description
</success_criteria>

<output>
After completion, create `.global-reader/phases/01-team-foundation/01-01-SUMMARY.md`
</output>

---
phase: 02-membership-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts
  - backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts
  - backend/nodejs/apps/src/modules/auth/container/auth.container.ts
autonomous: true

must_haves:
  truths:
    - "JIT-provisioned users are added to Global Reader team"
    - "Admin-created users (createUser) are added to Global Reader team"
    - "Bulk-imported users (addManyUsers) are added to Global Reader team"
    - "GlobalReaderTeamService is injected into JitProvisioningService"
    - "GlobalReaderTeamService is injected into UsersController"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts"
      provides: "JIT provisioning with Global Reader team addition"
      contains: "addUserToGlobalReader"
    - path: "backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts"
      provides: "User creation with Global Reader team addition"
      contains: "addUserToGlobalReader"
    - path: "backend/nodejs/apps/src/modules/auth/container/auth.container.ts"
      provides: "GlobalReaderTeamService binding for auth module"
      contains: "GlobalReaderTeamService"
  key_links:
    - from: "jit-provisioning.service.ts"
      to: "GlobalReaderTeamService"
      via: "Inversify DI injection"
      pattern: "@inject.*GlobalReaderTeamService"
    - from: "users.controller.ts"
      to: "GlobalReaderTeamService"
      via: "Inversify DI injection"
      pattern: "@inject.*GlobalReaderTeamService"
---

<objective>
Integrate Global Reader team membership into user creation flows

Purpose: Automatically add all new users to the Global Reader team at registration time, regardless of how they are created (SSO/JIT, admin single creation, admin bulk import).

Output: Modified user creation flows that call `addUserToGlobalReader` after user is created:
1. JitProvisioningService.provisionUser() - SSO/OAuth/SAML users
2. UsersController.createUser() - Admin single user creation
3. UsersController.addManyUsers() - Admin bulk user import
</objective>

<execution_context>
@/Users/Edward/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Edward/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.global-reader/PROJECT.md
@.global-reader/ROADMAP.md
@.global-reader/STATE.md
@.global-reader/phases/02-membership-automation/02-RESEARCH.md
@.global-reader/phases/02-membership-automation/02-01-SUMMARY.md
@backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts
@backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts
@backend/nodejs/apps/src/modules/auth/container/auth.container.ts
@backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts (GlobalReaderTeamService already bound)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate GlobalReaderTeamService into JitProvisioningService</name>
  <files>
    backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts
    backend/nodejs/apps/src/modules/auth/container/auth.container.ts
  </files>
  <action>
**Step 1: Update JitProvisioningService (jit-provisioning.service.ts)**

1. Add import at top of file:
```typescript
import { GlobalReaderTeamService } from '../../user_management/services/globalReaderTeam.service';
```

2. Add injection to constructor (around line 28):
```typescript
constructor(
  @inject('Logger') private logger: Logger,
  @inject('EntitiesEventProducer') private eventService: EntitiesEventProducer,
  @inject('GlobalReaderTeamService') private globalReaderTeamService: GlobalReaderTeamService,
) {}
```

3. In `provisionUser` method, add Global Reader team addition after the eventService.stop() call (around line 93, after the finally block):
```typescript
// Add user to Global Reader team (non-blocking)
await this.globalReaderTeamService.addUserToGlobalReader(
  orgId,
  newUser._id.toString(),
  {}, // Empty headers - internal call, auth context from org
);
```

**Important:** Place this AFTER the eventService try-catch-finally block but BEFORE the success log and return statement. The call should be around line 94-98.

**Step 2: Bind GlobalReaderTeamService in auth container (auth.container.ts)**

Find the auth.container.ts file and add binding for GlobalReaderTeamService. If it already imports from userManager.container, ensure GlobalReaderTeamService is included.

Add import:
```typescript
import { GlobalReaderTeamService } from '../../user_management/services/globalReaderTeam.service';
```

Add binding (if not already bound via userManager.container):
```typescript
container.bind<GlobalReaderTeamService>('GlobalReaderTeamService').to(GlobalReaderTeamService).inSingletonScope();
```

Note: Check if auth.container imports userManager.container bindings. If GlobalReaderTeamService is already bound there and accessible, skip the duplicate binding.
  </action>
  <verify>
Run:
```bash
grep -n "GlobalReaderTeamService\|addUserToGlobalReader" backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts
grep -n "GlobalReaderTeamService" backend/nodejs/apps/src/modules/auth/container/auth.container.ts
```
Expected: Import, injection, and method call in jit-provisioning.service.ts; binding in auth.container.ts
  </verify>
  <done>
- GlobalReaderTeamService injected into JitProvisioningService
- addUserToGlobalReader called after user saved in provisionUser method
- Service bound in auth container (or accessible via existing bindings)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Global Reader team membership to UsersController</name>
  <files>backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts</files>
  <action>
**Step 1: Add import** (if not already present from Phase 1):
```typescript
import { GlobalReaderTeamService } from '../services/globalReaderTeam.service';
```

**Step 2: Add injection to constructor**

Find the UsersController constructor and add:
```typescript
@inject('GlobalReaderTeamService') private globalReaderTeamService: GlobalReaderTeamService,
```

**Step 3: Update createUser method (around line 273)**

After `await newUser.save();` (line 273), add:
```typescript
// Add user to Global Reader team (non-blocking)
await this.globalReaderTeamService.addUserToGlobalReader(
  newUser.orgId.toString(),
  newUser._id.toString(),
  {
    authorization: req.headers.authorization || '',
    'x-org-id': req.user?.orgId?.toString() || '',
  },
);
```

**Step 4: Update addManyUsers method (around line 1244)**

Inside the loop that processes new users (after line 1244, inside the for loop at line 1215), add:
```typescript
// Add user to Global Reader team (non-blocking)
await this.globalReaderTeamService.addUserToGlobalReader(
  req.user?.orgId?.toString() || '',
  userId.toString(),
  {
    authorization: req.headers.authorization || '',
    'x-org-id': req.user?.orgId?.toString() || '',
  },
);
```

Place this after the UserGroups.updateOne call (around line 1232) and before the event publish.

**Note:** The GlobalReaderTeamService should already be bound in userManager.container.ts (from Phase 1). Verify this is true before adding redundant bindings.
  </action>
  <verify>
Run:
```bash
grep -n "addUserToGlobalReader" backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts
grep -c "addUserToGlobalReader" backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts
```
Expected: Two occurrences - one in createUser, one in addManyUsers
  </verify>
  <done>
- GlobalReaderTeamService injected into UsersController
- addUserToGlobalReader called in createUser after user.save()
- addUserToGlobalReader called in addManyUsers for each new user
- Headers passed for auth context
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify DI container bindings</name>
  <files>
    backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts
    backend/nodejs/apps/src/modules/auth/container/auth.container.ts
  </files>
  <action>
Verify that GlobalReaderTeamService is properly bound and accessible:

1. Check userManager.container.ts (should already have binding from Phase 1):
```bash
grep "GlobalReaderTeamService" backend/nodejs/apps/src/modules/user_management/container/userManager.container.ts
```

2. Check auth.container.ts imports userManager or has its own binding:
```bash
grep -E "GlobalReaderTeamService|userManager" backend/nodejs/apps/src/modules/auth/container/auth.container.ts
```

If auth.container.ts doesn't have access to GlobalReaderTeamService:
- Either import from userManager.container
- Or add the binding directly

The goal is that both JitProvisioningService and UsersController can inject GlobalReaderTeamService.
  </action>
  <verify>
Run TypeScript compilation (if node_modules available):
```bash
cd backend/nodejs/apps && npm run build 2>&1 | grep -i "error\|globalreader" | head -20
```
Expected: No TypeScript errors related to GlobalReaderTeamService injection
  </verify>
  <done>
- GlobalReaderTeamService bound in userManager.container (Phase 1)
- Auth container can resolve GlobalReaderTeamService
- No DI resolution errors
  </done>
</task>

</tasks>

<verification>
1. JIT provisioning integration:
```bash
grep -A3 "addUserToGlobalReader" backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts
```
Expected: Call with orgId, userId, headers

2. createUser integration:
```bash
grep -B2 -A3 "addUserToGlobalReader" backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts | head -10
```
Expected: Call after user save

3. addManyUsers integration:
```bash
grep -B2 -A3 "addUserToGlobalReader" backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts | tail -10
```
Expected: Call inside user loop

4. DI injection pattern:
```bash
grep "@inject.*GlobalReaderTeamService" backend/nodejs/apps/src/modules/auth/services/jit-provisioning.service.ts backend/nodejs/apps/src/modules/user_management/controller/users.controller.ts
```
Expected: Injection in both files

5. TypeScript compilation:
```bash
cd backend/nodejs/apps && npm run build 2>&1 | grep -c error || echo "Build successful"
```
Expected: 0 errors or "Build successful"
</verification>

<success_criteria>
1. JitProvisioningService injects GlobalReaderTeamService and calls addUserToGlobalReader after user creation
2. UsersController injects GlobalReaderTeamService
3. createUser method calls addUserToGlobalReader after newUser.save()
4. addManyUsers method calls addUserToGlobalReader for each new user in the loop
5. Auth container has GlobalReaderTeamService binding or access to it
6. TypeScript compiles without errors
7. All integration points pass headers for auth context
</success_criteria>

<output>
After completion, create `.global-reader/phases/02-membership-automation/02-02-SUMMARY.md`
</output>

---
phase: 02-membership-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
autonomous: true

must_haves:
  truths:
    - "addUserToGlobalReader method exists and is callable"
    - "READER role assigned when isAdmin=false"
    - "OWNER role assigned when isAdmin=true"
    - "Admin detection queries UserGroups with type='admin'"
    - "Team ID lookup finds Global Reader team by name"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts"
      provides: "addUserToGlobalReader method with role-based assignment"
      exports: ["GlobalReaderTeamService", "GLOBAL_READER_TEAM_NAME", "READER_ROLE", "OWNER_ROLE"]
  key_links:
    - from: "addUserToGlobalReader"
      to: "POST /api/v1/entity/team/{id}/users"
      via: "AIServiceCommand"
      pattern: "userRoles.*role"
    - from: "isUserAdmin"
      to: "UserGroups schema"
      via: "MongoDB query"
      pattern: "type.*admin"
---

<objective>
Add user membership method to GlobalReaderTeamService

Purpose: Enable automatic addition of users to Global Reader team with role-based privilege assignment (READER for regular users, OWNER for admins).

Output: Extended GlobalReaderTeamService with `addUserToGlobalReader(orgId, userId, headers)` method that:
1. Looks up Global Reader team ID by name
2. Determines if user is admin via UserGroups query
3. Calls Python backend API to add user with appropriate role
</objective>

<execution_context>
@/Users/Edward/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Edward/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.global-reader/PROJECT.md
@.global-reader/ROADMAP.md
@.global-reader/STATE.md
@.global-reader/phases/02-membership-automation/02-RESEARCH.md
@.global-reader/phases/01-team-foundation/01-01-SUMMARY.md
@backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
@backend/nodejs/apps/src/modules/user_management/middlewares/userAdminCheck.ts (admin detection pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role constants and admin detection method</name>
  <files>backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts</files>
  <action>
Add to globalReaderTeam.service.ts:

1. Export role constants after existing constants (around line 19):
```typescript
export const READER_ROLE = 'READER';
export const OWNER_ROLE = 'OWNER';
```

2. Add import for UserGroups schema at top of file:
```typescript
import { UserGroups } from '../schema/userGroup.schema';
```

3. Add private method `isUserAdmin` after the class constructor:
```typescript
/**
 * Check if user is member of admin group
 */
private async isUserAdmin(orgId: string, userId: string): Promise<boolean> {
  const groups = await UserGroups.find({
    orgId,
    users: { $in: [userId] },
    isDeleted: false,
  }).select('type');

  return groups.some((group: any) => group.type === 'admin');
}
```

This follows the exact pattern from userAdminCheck.ts middleware (line 27).
  </action>
  <verify>
Run: `grep -n "READER_ROLE\|OWNER_ROLE\|isUserAdmin\|UserGroups" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts`
Expected: See READER_ROLE, OWNER_ROLE exports, UserGroups import, and isUserAdmin method
  </verify>
  <done>Role constants exported, UserGroups imported, isUserAdmin method added using established admin detection pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add team ID lookup and addUserToGlobalReader method</name>
  <files>backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts</files>
  <action>
Add two methods to GlobalReaderTeamService:

1. Add TeamListResponse interface modification (update existing interface around line 12):
```typescript
interface TeamListResponse {
  teams?: Array<{ name: string; orgId: string; id?: string; _key?: string }>;
}
```

2. Add private helper to get team ID (after checkTeamExists method):
```typescript
/**
 * Get the Global Reader team ID for an organization
 * Returns null if team not found
 */
private async getGlobalReaderTeamId(
  orgId: string,
  headers: Record<string, string>,
): Promise<string | null> {
  const searchParams = new URLSearchParams({
    search: GLOBAL_READER_TEAM_NAME,
    limit: '100',
  });

  const aiCommandOptions: AICommandOptions = {
    uri: `${this.config.connectorBackend}/api/v1/entity/team/list?${searchParams.toString()}`,
    method: HttpMethod.GET,
    headers: {
      ...headers,
      'Content-Type': 'application/json',
    },
  };

  const aiCommand = new AIServiceCommand<TeamListResponse>(aiCommandOptions);
  const response = await aiCommand.execute();

  if (response.statusCode !== HTTP_STATUS.OK) {
    this.logger.warn('Failed to list teams for Global Reader lookup', {
      statusCode: response.statusCode,
      orgId,
    });
    return null;
  }

  const teams = response.data?.teams || [];
  const team = teams.find(
    (t) => t.name === GLOBAL_READER_TEAM_NAME && t.orgId === orgId,
  );

  return team?.id || team?._key || null;
}
```

3. Add public method `addUserToGlobalReader` (after ensureGlobalReaderTeamExists):
```typescript
/**
 * Add a user to the Global Reader team with appropriate role.
 * Admin users get OWNER role, regular users get READER role.
 * This method is non-blocking - errors are logged but not thrown.
 *
 * @param orgId - The organization ID
 * @param userId - The user ID to add
 * @param headers - HTTP headers for auth context
 */
async addUserToGlobalReader(
  orgId: string,
  userId: string,
  headers: Record<string, string>,
): Promise<void> {
  try {
    // Step 1: Get team ID
    const teamId = await this.getGlobalReaderTeamId(orgId, headers);
    if (!teamId) {
      this.logger.warn('Global Reader team not found, skipping user addition', {
        orgId,
        userId,
      });
      return;
    }

    // Step 2: Check if user is admin
    const isAdmin = await this.isUserAdmin(orgId, userId);
    const role = isAdmin ? OWNER_ROLE : READER_ROLE;

    // Step 3: Add user to team
    await this.addUserToTeam(teamId, userId, role, headers);
    this.logger.info('User added to Global Reader team', {
      orgId,
      userId,
      role,
    });
  } catch (error) {
    // Non-blocking: log error but don't throw
    this.logger.error('Failed to add user to Global Reader team', {
      orgId,
      userId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
}
```

4. Add private helper to call Python backend API (after addUserToGlobalReader):
```typescript
/**
 * Call Python backend to add user to team with specified role
 */
private async addUserToTeam(
  teamId: string,
  userId: string,
  role: string,
  headers: Record<string, string>,
): Promise<void> {
  const payload = {
    userRoles: [{ userId, role }],
  };

  const aiCommandOptions: AICommandOptions = {
    uri: `${this.config.connectorBackend}/api/v1/entity/team/${teamId}/users`,
    method: HttpMethod.POST,
    headers: {
      ...headers,
      'Content-Type': 'application/json',
    },
    body: payload,
  };

  const aiCommand = new AIServiceCommand(aiCommandOptions);
  const response = await aiCommand.execute();

  if (response.statusCode !== HTTP_STATUS.OK) {
    throw new Error(
      `Failed to add user to team: ${response.msg || 'Unknown error'}`,
    );
  }
}
```
  </action>
  <verify>
Run: `grep -n "addUserToGlobalReader\|getGlobalReaderTeamId\|addUserToTeam\|userRoles" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts`
Expected: See all three methods and userRoles payload pattern
  </verify>
  <done>
- getGlobalReaderTeamId finds team by name and returns ID
- addUserToGlobalReader orchestrates: lookup team -> check admin -> add user with role
- addUserToTeam calls Python API with userRoles format
- Non-blocking error handling throughout
  </done>
</task>

</tasks>

<verification>
1. File structure check:
```bash
grep -c "export const\|export class\|async.*(" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
```
Expected: Shows count of exports and methods (should be higher than before)

2. Role constants exported:
```bash
grep "READER_ROLE\|OWNER_ROLE" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts
```
Expected: Both constants defined

3. TypeScript compilation (if node_modules available):
```bash
cd backend/nodejs/apps && npm run build 2>&1 | head -20
```
Expected: No errors in globalReaderTeam.service.ts

4. Admin detection pattern matches existing middleware:
```bash
diff <(grep -A5 "isUserAdmin" backend/nodejs/apps/src/modules/user_management/services/globalReaderTeam.service.ts | grep "type.*admin") <(grep "type.*admin" backend/nodejs/apps/src/modules/user_management/middlewares/userAdminCheck.ts)
```
Expected: Similar pattern used
</verification>

<success_criteria>
1. GlobalReaderTeamService has `addUserToGlobalReader(orgId, userId, headers)` method
2. READER_ROLE and OWNER_ROLE constants are exported
3. Admin detection uses UserGroups query with type='admin' (same as existing middleware)
4. Method calls Python backend POST /api/v1/entity/team/{id}/users with userRoles format
5. All errors are logged but not thrown (non-blocking design)
</success_criteria>

<output>
After completion, create `.global-reader/phases/02-membership-automation/02-01-SUMMARY.md`
</output>

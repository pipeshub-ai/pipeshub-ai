---
phase: 01-schema-token-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts
  - backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
autonomous: true

must_haves:
  truths:
    - "OrgAuthConfig schema accepts microsoftTenantId field"
    - "MongoDB can efficiently query by microsoftTenantId"
    - "Code can extract tenant ID from a Microsoft JWT token"
    - "Existing auth flows continue to work unchanged"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts"
      provides: "IOrgAuthConfig interface with microsoftTenantId, schema with indexed field"
      contains: "microsoftTenantId"
    - path: "backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts"
      provides: "extractTenantIdFromToken helper function"
      exports: ["extractTenantIdFromToken"]
  key_links:
    - from: "orgAuthConfiguration.schema.ts"
      to: "MongoDB"
      via: "sparse index on microsoftTenantId"
      pattern: "index.*microsoftTenantId.*sparse"
    - from: "azureAdTokenValidation.ts"
      to: "JWT payload"
      via: "jwt.decode extraction"
      pattern: "payload\\.tid"
---

<objective>
Add infrastructure for Microsoft tenant ID storage and extraction.

Purpose: Enable org lookup by Microsoft Entra ID tenant ID instead of email domain, supporting 48+ company domains under a single SSO tenant.

Output:
- OrgAuthConfig schema with `microsoftTenantId` field and efficient index
- `extractTenantIdFromToken()` helper for extracting `tid` claim from Microsoft JWT
</objective>

<execution_context>
@C:\Users\isuru\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\isuru\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md

Key source files:
@backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts
@backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add microsoftTenantId field to OrgAuthConfig schema</name>
  <files>backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts</files>
  <action>
Update the OrgAuthConfig schema to support Microsoft tenant ID storage:

1. Add `microsoftTenantId?: string` to the `IOrgAuthConfig` interface (after `domain` field)

2. Add `microsoftTenantId` field to `OrgAuthConfigSchema` with:
   - type: String
   - index: true (for efficient lookup)
   - sparse: true (only index non-null values, saves space)

3. Add compound index for efficient lookups:
   ```typescript
   OrgAuthConfigSchema.index({ microsoftTenantId: 1, isDeleted: 1 });
   ```

The sparse index ensures:
- Fast O(1) lookup by tenant ID
- No index bloat from null values
- Efficient for queries like `{ microsoftTenantId: tid, isDeleted: false }`

Keep existing fields unchanged. This is an additive change.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend/nodejs/apps && npx tsc --noEmit src/modules/auth/schema/orgAuthConfiguration.schema.ts
```
  </verify>
  <done>
- IOrgAuthConfig interface includes `microsoftTenantId?: string`
- OrgAuthConfigSchema has microsoftTenantId field with sparse index
- Compound index on (microsoftTenantId, isDeleted) defined
- Existing fields unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add extractTenantIdFromToken helper function</name>
  <files>backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts</files>
  <action>
Add a new helper function to extract the tenant ID from a Microsoft JWT token:

```typescript
/**
 * Extracts the Microsoft Entra ID tenant ID (tid) from an ID token.
 *
 * SECURITY NOTE: This function decodes WITHOUT validating the signature.
 * Only use the result for org lookup, then validate with validateAzureAdUser().
 * The tid is untrusted until full validation completes.
 *
 * @param idToken - The Microsoft ID token (JWT string)
 * @returns The tenant ID (GUID) or null if extraction fails
 */
export const extractTenantIdFromToken = (idToken: string): string | null => {
  try {
    const decoded = jwt.decode(idToken, { complete: true });
    if (!decoded || !decoded.payload) {
      return null;
    }

    const payload = decoded.payload as JwtPayload;
    return payload.tid || null;
  } catch (error) {
    if (error instanceof Error) {
      logger.error('Error extracting tenant ID from token:', error.message);
    }
    return null;
  }
};
```

Place this function BEFORE `validateAzureAdUser` (around line 12) since it will be called first in the auth flow.

Key points:
- Uses existing `jwt` and `JwtPayload` imports (already imported)
- Uses existing `logger` instance (already instantiated)
- Returns null on any error (defensive)
- Clear security documentation in JSDoc
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend/nodejs/apps && npx tsc --noEmit src/modules/auth/utils/azureAdTokenValidation.ts
```

Function is exported:
```bash
grep -n "export const extractTenantIdFromToken" backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
```
  </verify>
  <done>
- `extractTenantIdFromToken` function exists and is exported
- Function accepts idToken string, returns tenant ID string or null
- JSDoc documents security considerations
- Uses existing imports (jwt, JwtPayload, logger)
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing auth still works</name>
  <files>backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts</files>
  <action>
Verify that the changes are non-breaking:

1. Check that `validateAzureAdUser` function signature and behavior are unchanged

2. Check that `handleAzureAuthCallback` function signature and behavior are unchanged

3. Run existing tests (if any) to confirm no regressions:
   ```bash
   cd backend/nodejs/apps && npm test -- --grep "azure" --passWithNoTests 2>/dev/null || echo "No azure tests found"
   ```

4. Verify the full file compiles with all dependencies:
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit
   ```

This task confirms backward compatibility before the phase is complete.
  </action>
  <verify>
Full TypeScript project compiles:
```bash
cd backend/nodejs/apps && npx tsc --noEmit
```

Existing exports still present:
```bash
grep -n "export const validateAzureAdUser" backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
grep -n "export const handleAzureAuthCallback" backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
```
  </verify>
  <done>
- Project compiles with no TypeScript errors
- validateAzureAdUser export unchanged
- handleAzureAuthCallback export unchanged
- No breaking changes to existing code
  </done>
</task>

</tasks>

<verification>
Phase 1 complete when:

1. **Schema verification:**
   ```bash
   grep -A5 "microsoftTenantId" backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts
   ```
   Should show field definition with sparse index.

2. **Helper function verification:**
   ```bash
   grep -A10 "extractTenantIdFromToken" backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
   ```
   Should show function with tid extraction logic.

3. **TypeScript compilation:**
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit
   ```
   Should complete with no errors.

4. **Index verification:**
   ```bash
   grep "index.*microsoftTenantId" backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts
   ```
   Should show compound index definition.
</verification>

<success_criteria>
- OrgAuthConfig.microsoftTenantId field exists with sparse index
- Compound index on (microsoftTenantId, isDeleted) defined
- extractTenantIdFromToken() function exported
- Function extracts `tid` claim from JWT payload
- Security documentation in JSDoc comments
- Full project compiles with no TypeScript errors
- Existing auth exports unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-token-extraction/01-01-SUMMARY.md`
</output>

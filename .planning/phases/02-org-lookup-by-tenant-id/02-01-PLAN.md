---
phase: 02-org-lookup-by-tenant-id
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
autonomous: true

must_haves:
  truths:
    - "Users from any of 48+ company domains can SSO via single Microsoft tenant"
    - "Org is matched by tenant ID from token, not email domain"
    - "Existing domain-based SSO continues to work as fallback"
    - "Logs show which lookup method matched the org"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts"
      provides: "Tenant ID org lookup with domain fallback in JIT Microsoft flow"
      contains: "extractTenantIdFromToken"
  key_links:
    - from: "userAccount.controller.ts (JIT Microsoft case)"
      to: "extractTenantIdFromToken()"
      via: "import and call before validateAzureAdUser()"
      pattern: "extractTenantIdFromToken\\(credentials"
    - from: "userAccount.controller.ts (JIT Microsoft case)"
      to: "OrgAuthConfig.findOne"
      via: "tenant ID query"
      pattern: "microsoftTenantId.*tenantId"
---

<objective>
Add tenant ID-based organization lookup in the JIT Microsoft SSO flow

Purpose: Enable users from any of 48+ company domains (aktor.ai, aktor.gr, biosar.gr, intrakat.com, etc.) to SSO via a single Microsoft tenant ID, rather than requiring each domain to be individually configured.

Output: Modified `userAccount.controller.ts` with tenant ID extraction and org lookup in the Microsoft JIT provisioning flow, with domain-based fallback for backward compatibility.
</objective>

<execution_context>
@C:\Users\isuru\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\isuru\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-token-extraction/01-01-SUMMARY.md
@.planning/phases/02-org-lookup-by-tenant-id/02-RESEARCH.md
@backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
@backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
@backend/nodejs/apps/src/modules/auth/schema/orgAuthConfiguration.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tenant ID org lookup in JIT Microsoft flow</name>
  <files>backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts</files>
  <action>
Modify the JIT provisioning Microsoft case (around line 1414) to use tenant ID-based org lookup:

1. **Add import** at top of file:
   ```typescript
   import { extractTenantIdFromToken, validateAzureAdUser } from '../utils/azureAdTokenValidation';
   ```
   (Note: validateAzureAdUser may already be imported - just add extractTenantIdFromToken)

2. **Before the Microsoft case switch block** (around line 1378, after `const orgId = sessionInfo.orgId`):

   Add logic to check if this is Microsoft auth and potentially override orgId:
   ```typescript
   // For Microsoft SSO, try tenant ID-based org lookup first
   let effectiveOrgId = orgId;
   let matchedBy: 'microsoftTenantId' | 'domain' = 'domain';

   if (method === AuthMethodType.MICROSOFT || method === AuthMethodType.AZURE_AD) {
     const idToken = credentials?.idToken;
     if (idToken) {
       const extractedTenantId = extractTenantIdFromToken(idToken);

       if (extractedTenantId) {
         // Try tenant ID lookup first (handles multi-domain orgs)
         const tenantOrgConfig = await OrgAuthConfig.findOne({
           microsoftTenantId: extractedTenantId,
           isDeleted: false,
         });

         if (tenantOrgConfig) {
           effectiveOrgId = tenantOrgConfig.orgId;
           matchedBy = 'microsoftTenantId';
           this.logger.info('Org matched by Microsoft tenant ID', {
             tenantId: extractedTenantId,
             orgId: effectiveOrgId?.toString(),
             email: sessionInfo.email,
           });
         } else {
           this.logger.debug('No org found for tenant ID, using domain fallback', {
             tenantId: extractedTenantId,
             fallbackOrgId: orgId?.toString(),
             email: sessionInfo.email,
           });
         }
       }
     }
   }
   ```

3. **Update newUser object** (around line 1384):
   Change from:
   ```typescript
   const newUser = { orgId, email: sessionInfo.email };
   ```
   To:
   ```typescript
   const newUser = { orgId: effectiveOrgId, email: sessionInfo.email };
   ```

4. **Update orgId check** (around line 1379-1380):
   Change from:
   ```typescript
   if (!orgId) {
   ```
   To:
   ```typescript
   if (!effectiveOrgId) {
   ```

5. **Update provisioning call** (around line 1483-1488):
   Change the `orgId` parameter to `effectiveOrgId`:
   ```typescript
   user = await this.jitProvisioningService.provisionUser(
     sessionInfo.email,
     userDetails,
     effectiveOrgId,  // Changed from orgId
     method === AuthMethodType.AZURE_AD ? 'azureAd' : method as 'google' | 'microsoft' | 'oauth',
   );
   ```

6. **Add enhanced logging** after successful provisioning (around line 1504):
   ```typescript
   this.logger.info('JIT provisioning completed', {
     email: sessionInfo.email,
     method,
     matchedBy,  // Add this field
     orgId: effectiveOrgId?.toString(),
   });
   ```

**Important:** Keep the existing domain-based `orgId` from sessionInfo as the fallback. The tenant ID lookup is an ADDITION, not a replacement.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend/nodejs/apps && npx tsc --noEmit
```
  </verify>
  <done>
- extractTenantIdFromToken() imported and called for Microsoft/AzureAD auth methods
- OrgAuthConfig.findOne() with microsoftTenantId query added
- effectiveOrgId used throughout JIT flow (check, newUser, provisionUser)
- Fallback to domain-based orgId when tenant lookup fails
- Logging includes matchedBy field showing 'microsoftTenantId' or 'domain'
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify TypeScript compilation and imports</name>
  <files>backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts</files>
  <action>
Ensure all imports are correct and code compiles:

1. **Check OrgAuthConfig import** - verify it's imported at top of file:
   ```typescript
   import { OrgAuthConfig } from '../schema/orgAuthConfiguration.schema';
   ```
   (May already exist - add if not)

2. **Verify no TypeScript errors**:
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit 2>&1 | grep -E "(error|Error)" | head -20
   ```

3. **Check for type issues**:
   - `effectiveOrgId` should be typed as `Types.ObjectId | string | undefined` (same as orgId from sessionInfo)
   - `matchedBy` should be typed as a union literal

4. **Fix any import issues** that arise from the added code.
  </action>
  <verify>
```bash
cd backend/nodejs/apps && npx tsc --noEmit 2>&1 | grep -i "userAccount" && echo "Check above for errors" || echo "No userAccount-related errors"
```
  </verify>
  <done>
- All imports present (extractTenantIdFromToken, OrgAuthConfig)
- TypeScript compiles without errors in userAccount.controller.ts
- No type mismatches between orgId and effectiveOrgId
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing auth still works</name>
  <files>backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts</files>
  <action>
Confirm backward compatibility by checking the logic flow:

1. **Verify non-Microsoft methods unaffected**:
   - Google, OAuth, Password auth should skip the tenant ID lookup entirely
   - They use `effectiveOrgId` which defaults to `orgId` (domain-based)

2. **Verify domain fallback works**:
   - When Microsoft auth has no tenant ID match, `effectiveOrgId` stays as `orgId`
   - `matchedBy` stays as 'domain'
   - Existing single-domain Microsoft SSO continues to work

3. **Grep for the pattern to confirm** tenant ID lookup is conditional:
   ```bash
   grep -n "method === AuthMethodType.MICROSOFT" backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
   ```

4. **Trace the logic**:
   - `effectiveOrgId = orgId` (default: domain-based)
   - IF Microsoft AND idToken AND extractedTenantId AND tenantOrgConfig → override effectiveOrgId
   - ELSE → effectiveOrgId remains domain-based
  </action>
  <verify>
Grep confirms conditional logic:
```bash
grep -A5 "effectiveOrgId = orgId" backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
```
  </verify>
  <done>
- Non-Microsoft auth methods bypass tenant ID lookup
- Microsoft auth without tenant ID match uses domain fallback
- Existing SSO flows (Google, single-domain Microsoft, OAuth) unaffected
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation passes:**
   ```bash
   cd backend/nodejs/apps && npx tsc --noEmit
   ```

2. **Code structure verification:**
   ```bash
   # Verify extractTenantIdFromToken is imported
   grep -n "extractTenantIdFromToken" backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts

   # Verify tenant ID query exists
   grep -n "microsoftTenantId" backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts

   # Verify logging with matchedBy
   grep -n "matchedBy" backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
   ```

3. **Logic verification:**
   - effectiveOrgId defaults to orgId (domain-based)
   - Tenant ID lookup only runs for Microsoft/AzureAD
   - Fallback to domain when tenant lookup fails
</verification>

<success_criteria>
- Users from any of 48+ domains sharing a Microsoft tenant can JIT provision
- Org is matched by extracting tenant ID from token, looking up in OrgAuthConfig
- Domain-based fallback ensures existing SSO continues working
- Logs clearly show whether org was matched by 'microsoftTenantId' or 'domain'
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-org-lookup-by-tenant-id/02-01-SUMMARY.md`
</output>

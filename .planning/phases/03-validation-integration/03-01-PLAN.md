---
phase: 03-validation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.spec.ts
  - backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.spec.ts
autonomous: true

must_haves:
  truths:
    - "extractTenantIdFromToken returns tid from valid JWT payload"
    - "extractTenantIdFromToken returns null for invalid/missing token"
    - "Tenant ID lookup finds org when microsoftTenantId matches"
    - "Fallback to domain-based lookup when no tenant match exists"
  artifacts:
    - path: "backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.spec.ts"
      provides: "Unit tests for extractTenantIdFromToken function"
      min_lines: 30
    - path: "backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.spec.ts"
      provides: "Integration tests for tenant ID org lookup in JIT flow"
      min_lines: 50
  key_links:
    - from: "azureAdTokenValidation.spec.ts"
      to: "azureAdTokenValidation.ts"
      via: "import extractTenantIdFromToken"
      pattern: "extractTenantIdFromToken"
    - from: "userAccount.controller.spec.ts"
      to: "OrgAuthConfig"
      via: "mock findOne with microsoftTenantId query"
      pattern: "microsoftTenantId"
---

<objective>
Write integration tests for the tenant ID-based organization lookup in Microsoft SSO flow.

Purpose: Verify tenant ID extraction and org lookup logic works correctly before manual validation.
Output: Test files that validate extractTenantIdFromToken and tenant-first org lookup pattern.
</objective>

<execution_context>
@C:\Users\isuru\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\isuru\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-token-extraction/01-01-SUMMARY.md
@.planning/phases/02-org-lookup-by-tenant-id/02-01-SUMMARY.md
@backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.ts
@backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.ts
@backend/nodejs/apps/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for extractTenantIdFromToken</name>
  <files>backend/nodejs/apps/src/modules/auth/utils/azureAdTokenValidation.spec.ts</files>
  <action>
Create unit tests for the extractTenantIdFromToken function using Mocha + Chai.

Test cases to cover:
1. Valid JWT with tid claim - returns extracted tenant ID
2. JWT without tid claim - returns null
3. Null/undefined token input - returns null
4. Invalid JWT format (not base64, wrong structure) - returns null gracefully
5. Empty string token - returns null

Use actual base64-encoded JWT payloads (no signature needed since function extracts without validation).

Structure:
```typescript
import { expect } from 'chai';
import { extractTenantIdFromToken } from './azureAdTokenValidation';

describe('extractTenantIdFromToken', () => {
  it('extracts tid from valid JWT payload', () => {...});
  it('returns null when tid claim is missing', () => {...});
  // etc.
});
```

Do NOT mock the function - test the real implementation directly.
  </action>
  <verify>Run `npm test -- --grep "extractTenantIdFromToken"` from backend/nodejs/apps - all tests pass</verify>
  <done>5+ test cases for extractTenantIdFromToken, all passing</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for tenant ID org lookup</name>
  <files>backend/nodejs/apps/src/modules/auth/controller/userAccount.controller.spec.ts</files>
  <action>
Create integration tests for the tenant ID-based org lookup logic in JIT provisioning using Mocha + Chai + Sinon.

Test cases to cover:
1. **Tenant ID match** - Mock OrgAuthConfig.findOne to return org when queried with microsoftTenantId, verify effectiveOrgId uses tenant-matched org
2. **Tenant ID no match, fallback to domain** - Mock OrgAuthConfig.findOne to return null for tenant query, verify effectiveOrgId uses original domain-based orgId
3. **Non-Microsoft method skips tenant lookup** - Verify Google/OAuth/Password methods don't query by microsoftTenantId
4. **Logs matchedBy correctly** - Verify logger.info called with matchedBy: 'microsoftTenantId' or 'domain'

Use Sinon to stub:
- OrgAuthConfig.findOne
- this.logger.info
- extractTenantIdFromToken (for controlled test scenarios)

The UserAccountController uses dependency injection (inversify), so mock the injected dependencies in test setup.

Note: These tests focus on the tenant lookup logic at lines 1378-1413 of userAccount.controller.ts. Do not test the entire JIT flow - just the tenant resolution logic.

Structure:
```typescript
import { expect } from 'chai';
import sinon from 'sinon';
import { OrgAuthConfig } from '../schema/orgAuthConfiguration.schema';

describe('UserAccountController - Tenant ID Org Lookup', () => {
  describe('Microsoft SSO JIT provisioning', () => {
    it('uses tenant ID matched org when found', async () => {...});
    it('falls back to domain when no tenant match', async () => {...});
    // etc.
  });
});
```
  </action>
  <verify>Run `npm test -- --grep "Tenant ID Org Lookup"` from backend/nodejs/apps - all tests pass</verify>
  <done>4+ test cases for tenant ID org lookup, all passing, matchedBy logging verified</done>
</task>

<task type="auto">
  <name>Task 3: Verify test suite runs cleanly</name>
  <files>backend/nodejs/apps/package.json</files>
  <action>
Run the full test suite to ensure:
1. New tests integrate with existing Mocha configuration
2. No import/compilation errors
3. All tests pass

If .mocharc.js or .mocharc.json doesn't exist, ensure tests can be discovered. May need to add to package.json scripts:
```json
"test:auth": "mocha 'src/modules/auth/**/*.spec.ts'"
```

Check TypeScript compilation:
```bash
cd backend/nodejs/apps && npm run build
```

Run tests:
```bash
cd backend/nodejs/apps && npm test
```

If tests don't run due to missing mocha config, create minimal .mocharc.json:
```json
{
  "require": ["ts-node/register"],
  "extension": ["ts"],
  "spec": "src/**/*.spec.ts"
}
```
  </action>
  <verify>
1. `npm run build` completes without errors in backend/nodejs/apps
2. `npm test` finds and runs all .spec.ts files
3. All tests pass
  </verify>
  <done>Test suite configured and running, all tests pass, TypeScript compiles</done>
</task>

</tasks>

<verification>
1. Unit tests exist for extractTenantIdFromToken with 5+ test cases
2. Integration tests exist for tenant ID org lookup with 4+ test cases
3. `npm test` in backend/nodejs/apps discovers and runs all tests
4. All tests pass
5. TypeScript compilation succeeds
</verification>

<success_criteria>
- extractTenantIdFromToken tested for valid JWT, missing tid, null input, invalid format
- Tenant ID org lookup tested for match, no-match-fallback, non-Microsoft skip, logging
- Test suite runs without configuration issues
- All tests green
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation-integration/03-01-SUMMARY.md`
</output>

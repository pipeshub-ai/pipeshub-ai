---
phase: 03-validation-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User from domain A (e.g., aktor.ai) can SSO successfully"
    - "User from domain B (e.g., biosar.gr) provisions under same org as domain A"
    - "Existing single-domain SSO users continue to work"
    - "Logs show matchedBy: microsoftTenantId for multi-domain org"
  artifacts: []
  key_links:
    - from: "Browser SSO flow"
      to: "userAccount.controller.ts JIT provisioning"
      via: "Microsoft OAuth callback"
      pattern: "matchedBy.*microsoftTenantId"
---

<objective>
Manually verify multi-domain SSO works end-to-end in staging/production and configure tenant ID if needed.

Purpose: Confirm the implementation works with real Microsoft accounts from different company domains.
Output: Verified multi-domain SSO functionality, org configured with correct tenant ID.
</objective>

<execution_context>
@C:\Users\isuru\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\isuru\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-org-lookup-by-tenant-id/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check if org has microsoftTenantId configured</name>
  <files></files>
  <action>
Query the database to check if the target organization has microsoftTenantId populated.

Run MongoDB query:
```javascript
db.orgauthconfigs.findOne({ orgId: ObjectId("<target-org-id>"), isDeleted: false }, { microsoftTenantId: 1, orgId: 1 })
```

If microsoftTenantId is null/missing, you'll need to populate it during the manual test (extract from a successful login token).

Log the result so user knows whether config update is needed.
  </action>
  <verify>Query executed, microsoftTenantId status known</verify>
  <done>Org's current microsoftTenantId status documented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual SSO verification with two domains</name>
  <what-built>
Multi-domain Microsoft SSO with tenant ID-based org lookup. Users from any of 48+ company domains should be able to SSO and provision under the same organization.

Phase 1 added: microsoftTenantId field to OrgAuthConfig, extractTenantIdFromToken helper
Phase 2 added: Tenant ID-based org lookup in JIT flow with domain fallback
  </what-built>
  <how-to-verify>
**Environment:** Test in staging first, then production

**Test 1: First domain user (e.g., aktor.ai)**
1. Open staging/production app in incognito browser
2. Click "Sign in with Microsoft"
3. Log in with a user from first domain (e.g., user@aktor.ai)
4. Verify: User is provisioned successfully
5. Check server logs for: `matchedBy: 'domain'` or `matchedBy: 'microsoftTenantId'`
6. Note the tenant ID from logs (if visible) or from token for config update

**Test 2: Second domain user (e.g., biosar.gr)**
1. Open staging/production app in NEW incognito browser
2. Click "Sign in with Microsoft"
3. Log in with a user from second domain (e.g., user@biosar.gr)
4. Verify: User is provisioned under SAME org as first domain user
5. Check server logs for: `matchedBy: 'microsoftTenantId'` (after tenant ID configured)

**Test 3: Existing user still works**
1. Log in with an existing user that previously used SSO
2. Verify: Login succeeds, no re-provisioning occurs
3. Check logs show normal login flow

**Expected Outcomes:**
- Both domain users end up in same organization
- After tenant ID configured: logs show `matchedBy: 'microsoftTenantId'`
- Existing users continue to work without changes
  </how-to-verify>
  <resume-signal>
Report results:
- "approved" if all tests pass
- Describe issues if any test fails
- Provide tenant ID if extracted from logs (for config update)
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Update org config with tenant ID (if needed)</name>
  <files></files>
  <action>
If the user provides a tenant ID from the manual test (or if it was missing in Task 1), update the OrgAuthConfig with the microsoftTenantId.

MongoDB update command:
```javascript
db.orgauthconfigs.updateOne(
  { orgId: ObjectId("<target-org-id>"), isDeleted: false },
  { $set: { microsoftTenantId: "<tenant-id-from-user>" } }
)
```

Verify the update:
```javascript
db.orgauthconfigs.findOne({ orgId: ObjectId("<target-org-id>"), isDeleted: false }, { microsoftTenantId: 1 })
```

If tenant ID was already configured and tests passed, skip this task.
  </action>
  <verify>Query shows microsoftTenantId is now populated (or was already populated)</verify>
  <done>Org's microsoftTenantId configured correctly</done>
</task>

</tasks>

<verification>
1. User from domain A can SSO successfully
2. User from domain B provisions under same org as domain A
3. Server logs show correct matchedBy value
4. Existing SSO users continue to work
5. Org's microsoftTenantId is configured in database
</verification>

<success_criteria>
- Minimum 2 different domains tested
- Both users end up in same organization
- Logs confirm tenant ID matching works
- No regressions for existing users
- Org config updated with tenant ID (if it was missing)
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation-integration/03-02-SUMMARY.md`
</output>
